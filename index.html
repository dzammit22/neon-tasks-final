<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TaskForge — Offline Task + Score Tracker</title>
<meta name="theme-color" content="#101418" />
<style>
  :root{
    --bg:#0e1116;
    --elev:#151a22;
    --card:#1a202b;
    --text:#e7eef7;
    --muted:#9bb0c3;
    --brand:#6dd3fb;
    --accent:#7df8c3;
    --danger:#ff6b6b;
    --warn:#ffbe55;
    --ok:#56f39a;
    --ring: 0 0 0 2px color-mix(in oklab, var(--brand) 55%, transparent);
    --radius:14px;
    --shadow: 0 6px 24px rgba(0,0,0,.35);
    --tab-h: 64px;
    --gap: 12px;
    --cat-Home:#7aa2f7;
    --cat-Fitness:#f7768e;
    --cat-Finance:#9ece6a;
    --cat-Skills:#bb9af7;
    --cat-Work:#e0af68;
    --cat-Rose:#ff8fb1;
    --cat-Other:#7dcfff;
    --prio-low:#8ab4f8;
    --prio-med:#fdd663;
    --prio-high:#ff8a80;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:linear-gradient(180deg,#0b0f14, #0e1116 45%, #0e1116 100%);
    color:var(--text);font:500 16px/1.35 ui-sans-serif,system-ui,-apple-system,Inter,Segoe UI,Roboto,Helvetica,Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .app{
    max-width:820px; margin:0 auto; min-height:100dvh; display:flex; flex-direction:column;
  }
  header{
    position:sticky; top:0; z-index:5; backdrop-filter:saturate(1.1) blur(10px);
    background:color-mix(in oklab, var(--bg) 72%, black);
    padding:14px 16px 10px; border-bottom:1px solid rgba(255,255,255,.06);
  }
  header .row{display:flex;align-items:center;gap:12px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{
    inline-size:34px; block-size:34px; border-radius:10px; display:grid; place-items:center;
    background:radial-gradient(120% 120% at 10% 10%, var(--brand), var(--accent) 55%, #2b2f36 100%);
    color:#0a0f14; font-weight:900;
    box-shadow:inset 0 0 10px rgba(255,255,255,.35), var(--shadow);
  }
  .brand h1{font-size:18px; margin:0}
  .pill{
    margin-left:auto; background:color-mix(in oklab, var(--card) 88%, black);
    padding:8px 10px;border-radius:999px; color:var(--muted); display:flex; gap:10px; align-items:center;
    border:1px solid rgba(255,255,255,.06)
  }
  .pill b{color:var(--text)}
  main{flex:1; display:grid; grid-template-rows:1fr}
  section.view{display:none; padding:14px}
  section.view.active{display:block}
  .card{
    background:linear-gradient(180deg, color-mix(in oklab, var(--card) 88%, black), var(--elev));
    border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);
  }
  .card.pad{padding:14px}
  .grid{display:grid; gap:var(--gap)}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .grid.cols-auto{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  .row{display:flex; gap:10px; align-items:center}
  .spaced{justify-content:space-between}
  label{color:var(--muted); font-size:12px}
  input,select,textarea,button{
    width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
    background:#0f141b; color:var(--text); outline:none;
  }
  input:focus,select:focus,textarea:focus{box-shadow:var(--ring); border-color:transparent}
  button{
    background:linear-gradient(180deg, color-mix(in oklab, var(--brand) 20%, #0c1520), #0d2030);
    border:1px solid color-mix(in oklab, var(--brand) 50%, #000); color:#cfefff; font-weight:700; cursor:pointer;
  }
  button.ghost{
    background:transparent; border:1px dashed rgba(255,255,255,.15); color:var(--muted)
  }
  button.warn{background:linear-gradient(180deg, var(--danger), #c23b3b); color:white; border:none}
  .kpi{
    display:flex; flex-wrap:wrap; gap:10px
  }
  .kpi .tile{
    flex:1 1 140px; min-width:140px; padding:12px; border-radius:14px;
    background:linear-gradient(180deg, #111722, #0f141b); border:1px solid rgba(255,255,255,.06)
  }
  .tile .big{font-size:22px; font-weight:800}
  .tile small{color:var(--muted)}
  .badge{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15); color:var(--muted)}
  .cat-badge{color:#0b0f14; border:none; font-weight:800}
  .cat-Home{background:var(--cat-Home)}
  .cat-Fitness{background:var(--cat-Fitness)}
  .cat-Finance{background:var(--cat-Finance)}
  .cat-Skills{background:var(--cat-Skills)}
  .cat-Work{background:var(--cat-Work)}
  .cat-Rose{background:var(--cat-Rose)}
  .cat-Other{background:var(--cat-Other)}
  .prio{display:inline-flex; gap:6px; align-items:center}
  .dot{inline-size:10px; block-size:10px; border-radius:50%}
  .low{background:var(--prio-low)} .med{background:var(--prio-med)} .high{background:var(--prio-high)}
  .task{
    display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; padding:10px 12px;
    border-bottom:1px dashed rgba(255,255,255,.08)
  }
  .task:last-child{border-bottom:none}
  .task input[type="checkbox"]{width:22px; height:22px; accent-color:var(--accent)}
  .task .title{font-weight:700}
  .task .meta{font-size:12px; color:var(--muted)}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted)}
  .calendar{padding:8px}
  .cal-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
  .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
  .dow,.cell{
    text-align:center; padding:8px 0; border-radius:12px; background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.06);
  }
  .dow{font-size:12px; color:var(--muted); background:transparent;border:none}
  .cell{min-height:54px; position:relative}
  .cell .d{font-weight:800; color:var(--text)}
  .cell .evt{position:absolute; left:6px; right:6px; bottom:6px; display:flex; gap:4px; justify-content:center; flex-wrap:wrap}
  .cell .evt .p{inline-size:6px; block-size:6px; border-radius:999px}
  .cell.today{outline:2px solid color-mix(in oklab, var(--accent) 70%, transparent)}
  .cell.other{opacity:.4}
  .sheet{
    position:fixed; left:0; right:0; bottom:var(--tab-h); background:var(--elev); border-top:1px solid rgba(255,255,255,.08);
    max-height:55vh; overflow:auto; border-radius:16px 16px 0 0; box-shadow:0 -10px 40px rgba(0,0,0,.5); display:none
  }
  .sheet.open{display:block}
  .sheet header{position:sticky; top:0}
  .sheet .item{padding:12px 14px; border-bottom:1px dashed rgba(255,255,255,.08)}
  .sheet .item:last-child{border-bottom:none}
  .tabs{
    position:sticky; bottom:0; z-index:6; height:var(--tab-h); display:grid; grid-template-columns:repeat(5,1fr);
    background:color-mix(in oklab, var(--bg) 88%, black); border-top:1px solid rgba(255,255,255,.08)
  }
  .tab{
    display:grid; place-items:center; gap:4px; color:var(--muted); font-size:12px; text-decoration:none
  }
  .tab svg{width:24px; height:24px; opacity:.9}
  .tab.active{color:var(--text)}
  .sr-only{position:absolute; width:1px; height:1px; margin:-1px; border:0; padding:0; clip:rect(0 0 0 0); overflow:hidden}
  /* Larger */
  @media(min-width:700px){
    main{padding-bottom:10px}
    .sheet{left:50%; right:50%; transform:translateX(-50%); width:min(640px,96vw)}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <header class="card">
    <div class="row">
      <div class="brand">
        <div class="logo" aria-hidden="true">★</div>
        <h1>TaskForge</h1>
      </div>
      <div class="pill"><small>Completed</small> <b id="kpiTotal">0</b></div>
      <div class="pill"><small>Score</small> <b id="kpiScore">0</b></div>
    </div>
  </header>

  <main>
    <!-- TODAY -->
    <section id="view-today" class="view active">
      <div class="grid">
        <div class="card pad">
          <div class="row spaced">
            <h2 style="margin:2px 0">Today</h2>
            <button id="btnQuickAdd">+ Quick Task</button>
          </div>
          <div class="chips" id="todayFilters"></div>
          <div id="todayList"></div>
        </div>
        <div class="card pad">
          <h3 style="margin-top:0">Add Task</h3>
          <form id="taskForm" class="grid" autocomplete="off">
            <div>
              <label>Title</label>
              <input required name="title" placeholder="e.g., 30-min run, Pay bill…" />
            </div>
            <div class="grid cols-2">
              <div>
                <label>Category</label>
                <select name="category" required></select>
              </div>
              <div>
                <label>Priority</label>
                <select name="priority" required>
                  <option value="Low">Low</option>
                  <option value="Medium">Medium</option>
                  <option value="High">High</option>
                </select>
              </div>
            </div>
            <div class="grid cols-2">
              <div>
                <label>Due date</label>
                <input name="due" type="date" required />
              </div>
              <div>
                <label>Time (optional)</label>
                <input name="time" type="time" />
              </div>
            </div>
            <div>
              <label>Notes</label>
              <textarea name="notes" rows="2" placeholder="Details…"></textarea>
            </div>
            <div class="grid cols-2">
              <button type="submit">Add</button>
              <button type="reset" class="ghost">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="view-calendar" class="view">
      <div class="card pad calendar">
        <div class="cal-head">
          <button id="calPrev" class="ghost">◀</button>
          <div class="row" style="gap:8px">
            <h2 id="calTitle" style="margin:0"></h2>
            <span class="badge" id="calTodayBtn" role="button" tabindex="0">Jump to Today</span>
          </div>
          <button id="calNext" class="ghost">▶</button>
        </div>
        <div class="cal-grid" id="calDow"></div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
      <div class="sheet" id="daySheet" aria-live="polite">
        <header class="card pad">
          <div class="row spaced">
            <h3 id="sheetTitle" style="margin:0">Date</h3>
            <button id="closeSheet" class="ghost">Close</button>
          </div>
        </header>
        <div id="sheetBody"></div>
      </div>
    </section>

    <!-- TASKS -->
    <section id="view-tasks" class="view">
      <div class="card pad grid">
        <div class="grid cols-3">
          <div>
            <label>Search</label>
            <input id="searchInput" placeholder="Find by title or notes…" />
          </div>
          <div>
            <label>Category</label>
            <select id="filterCategory"></select>
          </div>
          <div>
            <label>Status</label>
            <select id="filterStatus">
              <option value="all">All</option>
              <option value="open">Open</option>
              <option value="done">Completed</option>
            </select>
          </div>
        </div>
        <div id="taskList"></div>
      </div>
    </section>

    <!-- STATS -->
    <section id="view-stats" class="view">
      <div class="grid">
        <div class="card pad">
          <h3 style="margin-top:0">Scores by Category</h3>
          <div class="kpi" id="scoreGrid"></div>
        </div>
        <div class="card pad">
          <h3 style="margin-top:0">Completed Counters</h3>
          <div id="counterTable"></div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="view-settings" class="view">
      <div class="grid">
        <div class="card pad">
          <h3 style="margin-top:0">Priority Weights (affects scores)</h3>
          <form id="weightsForm" class="grid cols-3">
            <div>
              <label>Low</label>
              <input type="number" min="0" step="1" name="low" />
            </div>
            <div>
              <label>Medium</label>
              <input type="number" min="0" step="1" name="med" />
            </div>
            <div>
              <label>High</label>
              <input type="number" min="0" step="1" name="high" />
            </div>
            <div class="grid cols-3" style="grid-column:1/-1">
              <button type="submit">Save</button>
              <button type="button" id="btnResetWeights" class="ghost">Reset</button>
              <span class="badge">Current total score: <b id="liveScore">0</b></span>
            </div>
          </form>
        </div>

        <div class="card pad">
          <h3 style="margin-top:0">Backup / Restore</h3>
          <div class="grid cols-3">
            <button id="btnExport">Export JSON</button>
            <label class="row" style="gap:8px">
              <input type="file" id="importFile" accept="application/json" />
            </label>
            <button id="btnImport" class="ghost">Import (replace)</button>
          </div>
          <p style="color:var(--muted);margin-top:8px">
            Export includes <b>all tasks</b>, <b>completed counters</b>, <b>scores</b>, and <b>settings</b>. Import replaces current data.
          </p>
          <div class="grid cols-2">
            <button id="btnClearAll" class="warn">Danger: Clear All Data</button>
            <button id="btnInstall" class="ghost">Install App (Add to Home)</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Tabs -->
  <nav class="tabs card" role="tablist" aria-label="Primary">
    <a class="tab active" data-view="view-today" role="tab" aria-selected="true">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 7h8v2H8zM5 4h14a2 2 0 0 1 2 2v12.5a1.5 1.5 0 0 1-1.5 1.5H4.5A1.5 1.5 0 0 1 3 18.5V6a2 2 0 0 1 2-2zm0 4h14v10H5z"/></svg>
      Today
    </a>
    <a class="tab" data-view="view-calendar" role="tab" aria-selected="false">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h2v3H7zm8 0h2v3h-2zM3 6a2 2 0 0 1 2-2h1v3h2V4h6v3h2V4h1a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2zm2 4h14v10H5zm2 2h3v3H7z"/></svg>
      Calendar
    </a>
    <a class="tab" data-view="view-tasks" role="tab" aria-selected="false">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 11h8v2H9zM9 7h8v2H9zM5 7h2v2H5zM5 11h2v2H5zM5 15h2v2H5zM9 15h8v2H9z"/></svg>
      Tasks
    </a>
    <a class="tab" data-view="view-stats" role="tab" aria-selected="false">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 3h4v18H5zM10 9h4v12h-4zM15 13h4v8h-4z"/></svg>
      Stats
    </a>
    <a class="tab" data-view="view-settings" role="tab" aria-selected="false">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm8.94 4.5a7 7 0 0 0-.16-1.5l2.12-1.65-2-3.46-2.57 1a7.5 7.5 0 0 0-1.3-.75l-.4-2.72h-4l-.4 2.72c-.45.18-.88.4-1.29.66l-2.6-1.07-2 3.46 2.1 1.63a7.5 7.5 0 0 0-.05 1.68l-2.05 1.58 2 3.46 2.56-1.02c.4.28.83.51 1.28.7l.41 2.68h4l.41-2.68c.45-.19.88-.42 1.28-.7l2.56 1.02 2-3.46z"/></svg>
      Settings
    </a>
  </nav>
</div>

<script>
/* =========================
   TASKFORGE — CORE LOGIC
   ========================= */

(() => {
  const CATS = ["Home","Fitness","Finance","Skills","Work","Rose","Other"];
  const CAT_COLORS = {
    Home:"var(--cat-Home)",
    Fitness:"var(--cat-Fitness)",
    Finance:"var(--cat-Finance)",
    Skills:"var(--cat-Skills)",
    Work:"var(--cat-Work)",
    Rose:"var(--cat-Rose)",
    Other:"var(--cat-Other)"
  };
  const STORAGE_KEY = "taskforge.v1";
  const DEFAULT_WEIGHTS = {Low:1, Medium:3, High:5};

  /** ---------- State ---------- **/
  let state = loadState() || freshState();

  function freshState(){
    const byCat = Object.fromEntries(CATS.map(c => [c, {Low:0,Medium:0,High:0}]));
    return {
      version:1,
      tasks:[],
      counters:{
        totalCompleted:0,
        byCategoryPriority: byCat
      },
      weights: {...DEFAULT_WEIGHTS},
      scores: { byCategory:Object.fromEntries(CATS.map(c=>[c,0])), total:0 },
      settings:{}
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      // Basic migration/guards
      obj.weights ||= {...DEFAULT_WEIGHTS};
      obj.counters ||= { totalCompleted:0, byCategoryPriority:Object.fromEntries(CATS.map(c=>[c,{Low:0,Medium:0,High:0}])) };
      obj.scores ||= { byCategory:Object.fromEntries(CATS.map(c=>[c,0])), total:0 };
      obj.tasks ||= [];
      // Ensure counters align with categories
      for(const c of CATS){
        obj.counters.byCategoryPriority[c] ||= {Low:0,Medium:0,High:0};
        obj.scores.byCategory[c] ||= 0;
      }
      return obj;
    }catch(e){ console.error(e); return null; }
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    refreshAll();
  }

  /** ---------- Utilities ---------- **/
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];
  const fmtDate = d => new Date(d).toISOString().slice(0,10);
  function todayStr(){ return fmtDate(new Date()); }
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function clampMonth(year, month){ // month may be -1..12 etc.
    const d = new Date(year, month, 1);
    return {year:d.getFullYear(), month:d.getMonth()};
  }
  function prioDot(p){
    return `<span class="dot ${p==='High'?'high':p==='Medium'?'med':'low'}" title="${p}"></span>`;
  }
  function catBadge(cat){
    return `<span class="badge cat-badge cat-${cat}">${cat}</span>`;
  }

  /** ---------- Scoring & Counters ---------- **/
  function recomputeScores(){
    const weights = state.weights;
    const byCat = Object.fromEntries(CATS.map(c=>[c,0]));
    let total = 0;
    for(const t of state.tasks){
      if(!t.completed) continue;
      const w = weights[t.priority] ?? 0;
      byCat[t.category] += w;
      total += w;
    }
    state.scores.byCategory = byCat;
    state.scores.total = total;
  }

  function toggleComplete(id, checked){
    const t = state.tasks.find(x=>x.id===id);
    if(!t) return;
    if(t.completed === checked) return;
    t.completed = checked;
    t.completedAt = checked ? new Date().toISOString() : null;
    // Update counters
    const bucket = state.counters.byCategoryPriority[t.category];
    if(checked){
      bucket[t.priority] += 1;
      state.counters.totalCompleted += 1;
    }else{
      bucket[t.priority] = Math.max(0, bucket[t.priority]-1);
      state.counters.totalCompleted = Math.max(0, state.counters.totalCompleted-1);
    }
    recomputeScores();
    saveState();
  }

  /** ---------- DOM Setup ---------- **/
  // Populate category selects
  (function fillCategorySelects(){
    $$('select[name="category"], #filterCategory').forEach(sel=>{
      sel.innerHTML = '<option value="all">All</option>';
      if(sel.id==='filterCategory'){
        sel.value='all';
      } else {
        sel.innerHTML = '';
      }
      for(const c of CATS){
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
      }
    });
  })();

  // Priority weights form
  (function initWeights(){
    const f = $('#weightsForm');
    f.low.value = state.weights.Low;
    f.med.value = state.weights.Medium;
    f.high.value = state.weights.High;
    f.addEventListener('submit', (e)=>{
      e.preventDefault();
      state.weights = {Low:+f.low.value||0, Medium:+f.med.value||0, High:+f.high.value||0};
      recomputeScores(); saveState();
    });
    $('#btnResetWeights').addEventListener('click', ()=>{
      state.weights = {...DEFAULT_WEIGHTS};
      initWeights(); recomputeScores(); saveState();
    });
  })();

  // Tabs
  $$('.tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const target = t.dataset.view;
      $$('.view').forEach(v=>v.classList.remove('active'));
      $('#'+target).classList.add('active');
    });
  });

  // Quick add (prefill for today)
  $('#btnQuickAdd').addEventListener('click', ()=>{
    const f = $('#taskForm');
    f.title.value = '';
    f.category.value = 'Other';
    f.priority.value = 'Low';
    f.due.value = todayStr();
    f.time.value = '';
    f.notes.value = '';
    f.title.focus();
  });

  // Add task form
  (function initTaskForm(){
    const f = $('#taskForm');
    f.due.value = todayStr();
    f.category.value = 'Other';
    f.addEventListener('submit', (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(f).entries());
      const task = {
        id: uid(),
        title: (data.title||'').trim(),
        category: data.category,
        priority: data.priority,
        due: data.due,
        time: data.time || '',
        notes: (data.notes||'').trim(),
        completed:false,
        createdAt: new Date().toISOString(),
        completedAt:null
      };
      state.tasks.push(task);
      saveState();
      f.reset();
      f.due.value = todayStr();
      f.category.value = 'Other';
    });
  })();

  // Filters in Tasks
  $('#searchInput').addEventListener('input', renderTaskList);
  $('#filterCategory').addEventListener('change', renderTaskList);
  $('#filterStatus').addEventListener('change', renderTaskList);

  // Today filters chips (categories)
  (function buildTodayFilters(){
    const wrap = $('#todayFilters');
    wrap.innerHTML = '';
    const all = document.createElement('span');
    all.className='chip'; all.textContent='All'; all.dataset.cat='all';
    wrap.appendChild(all);
    for(const c of CATS){
      const chip = document.createElement('span');
      chip.className='chip'; chip.textContent=c; chip.dataset.cat=c;
      chip.style.borderColor = 'transparent';
      chip.style.background = 'linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03))';
      chip.style.boxShadow = `inset 0 0 0 2px ${CAT_COLORS[c]}`;
      wrap.appendChild(chip);
    }
    wrap.addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip');
      if(!chip) return;
      wrap.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      chip.classList.add('active');
      renderTodayList(chip.dataset.cat);
    });
    all.classList.add('active');
  })();

  /** ---------- Calendar ---------- **/
  const cal = {
    anchor: new Date(),
    gridEl: $('#calGrid'),
    dowEl: $('#calDow'),
    titleEl: $('#calTitle')
  };
  function renderCalHeader(){
    cal.dowEl.innerHTML = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']
      .map(d=>`<div class="dow">${d}</div>`).join('');
  }
  function renderCalendar(){
    const year = cal.anchor.getFullYear(), month = cal.anchor.getMonth();
    const first = new Date(year, month, 1);
    const startDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();
    const prevDays = new Date(year, month, 0).getDate();

    $('#calTitle').textContent = first.toLocaleString(undefined, {month:'long', year:'numeric'});

    const cells = [];
    // prev month padding
    for(let i=0;i<startDay;i++){
      const d = prevDays - startDay + 1 + i;
      const date = new Date(year, month-1, d);
      cells.push(makeDayCell(date, true));
    }
    // current month
    for(let d=1; d<=daysInMonth; d++){
      const date = new Date(year, month, d);
      cells.push(makeDayCell(date, false));
    }
    // next padding to fill 6 rows (42 cells)
    while(cells.length % 7 !== 0 || cells.length < 42){
      const d = cells.length - (startDay + daysInMonth) + 1;
      const date = new Date(year, month+1, d);
      cells.push(makeDayCell(date, true));
    }
    cal.gridEl.innerHTML = cells.join('');
    // click handlers
    cal.gridEl.querySelectorAll('.cell').forEach(cell=>{
      cell.addEventListener('click', ()=>{
        const date = cell.dataset.date;
        openDaySheet(date);
      });
    });
  }

  function makeDayCell(date, other){
    const dstr = fmtDate(date);
    const isToday = dstr === todayStr();
    const events = state.tasks.filter(t=>t.due===dstr);
    const dots = events.slice(0,6).map(t=>`<span class="p" title="${t.title}" style="background:${CAT_COLORS[t.category]}"></span>`).join('');
    return `
      <div class="cell ${isToday?'today':''} ${other?'other':''}" data-date="${dstr}">
        <div class="d">${date.getDate()}</div>
        <div class="evt">${dots}</div>
      </div>`;
  }

  $('#calPrev').addEventListener('click', ()=>{
    const {year,month} = clampMonth(cal.anchor.getFullYear(), cal.anchor.getMonth()-1);
    cal.anchor = new Date(year,month,1);
    renderCalendar();
  });
  $('#calNext').addEventListener('click', ()=>{
    const {year,month} = clampMonth(cal.anchor.getFullYear(), cal.anchor.getMonth()+1);
    cal.anchor = new Date(year,month,1);
    renderCalendar();
  });
  $('#calTodayBtn').addEventListener('click', ()=>{
    cal.anchor = new Date();
    renderCalendar();
  });
  $('#closeSheet').addEventListener('click', ()=>$('#daySheet').classList.remove('open'));

  function openDaySheet(dstr){
    const title = new Date(dstr+'T00:00').toLocaleDateString(undefined,{weekday:'long', month:'short', day:'numeric', year:'numeric'});
    $('#sheetTitle').textContent = title;
    const list = state.tasks.filter(t=>t.due===dstr).sort((a,b)=> (a.time||'').localeCompare(b.time||''));
    const body = $('#sheetBody');
    body.innerHTML = '';
    if(list.length===0){
      body.innerHTML = `<div class="item">No tasks for this date.</div>`;
    }else{
      for(const t of list){
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div class="task">
            <input type="checkbox" ${t.completed?'checked':''} aria-label="Mark complete">
            <div>
              <div class="title">${t.title}</div>
              <div class="meta">
                ${t.time?`⏰ ${t.time} • `:''}${catBadge(t.category)} •
                <span class="prio">${prioDot(t.priority)} ${t.priority}</span>
              </div>
              ${t.notes?`<div class="meta" style="margin-top:4px">${t.notes}</div>`:''}
            </div>
            <button class="ghost" data-act="edit">Edit</button>
          </div>`;
        const cb = row.querySelector('input[type="checkbox"]');
        cb.addEventListener('change', ()=>toggleComplete(t.id, cb.checked));
        row.querySelector('[data-act="edit"]').addEventListener('click', ()=>editTaskDialog(t));
        body.appendChild(row);
      }
    }
    $('#daySheet').classList.add('open');
  }

  /** ---------- Renderers ---------- **/
  function renderTodayList(filterCat='all'){
    const today = todayStr();
    let list = state.tasks.filter(t=>t.due===today);
    if(filterCat!=='all') list = list.filter(t=>t.category===filterCat);
    // open first
    const open = list.filter(t=>!t.completed);
    const done = list.filter(t=>t.completed);
    const container = $('#todayList');
    container.innerHTML = '';
    const block = (arr, label) => {
      if(arr.length===0) return '';
      return `
        <div class="row spaced" style="margin-top:8px">
          <h4 style="margin:2px 0">${label}</h4>
          <span class="badge">${arr.length}</span>
        </div>
        <div class="card" style="margin-top:6px">
          ${arr.map(renderTaskItem).join('')}
        </div>`;
    };
    container.insertAdjacentHTML('beforeend', block(open, 'Up Next'));
    container.insertAdjacentHTML('beforeend', block(done, 'Completed'));
    container.querySelectorAll('.task input[type="checkbox"]').forEach(cb=>{
      const id = cb.closest('.task').dataset.id;
      cb.addEventListener('change', ()=>toggleComplete(id, cb.checked));
    });
    container.querySelectorAll('[data-act="edit"]').forEach(btn=>{
      const id = btn.closest('.task').dataset.id;
      btn.addEventListener('click', ()=>editTaskDialog(state.tasks.find(t=>t.id===id)));
    });
  }

  function renderTaskItem(t){
    return `
      <div class="task" data-id="${t.id}">
        <input type="checkbox" ${t.completed?'checked':''} />
        <div>
          <div class="title">${t.title}</div>
          <div class="meta">
            📅 ${t.due}${t.time?` • ⏰ ${t.time}`:''} •
            ${catBadge(t.category)} • <span class="prio">${prioDot(t.priority)} ${t.priority}</span>
          </div>
          ${t.notes?`<div class="meta" style="margin-top:4px">${t.notes}</div>`:''}
        </div>
        <div class="row" style="gap:6px">
          <button class="ghost" data-act="edit">Edit</button>
          <button class="ghost" data-act="del">Del</button>
        </div>
      </div>`;
  }

  function renderTaskList(){
    const q = ($('#searchInput').value||'').toLowerCase();
    const cat = $('#filterCategory').value;
    const status = $('#filterStatus').value;
    let list = state.tasks.slice().sort((a,b)=> (a.due+a.time).localeCompare(b.due+b.time));
    if(q) list = list.filter(t=>t.title.toLowerCase().includes(q) || (t.notes||'').toLowerCase().includes(q));
    if(cat!=='all') list = list.filter(t=>t.category===cat);
    if(status==='open') list = list.filter(t=>!t.completed);
    if(status==='done') list = list.filter(t=>t.completed);
    const container = $('#taskList');
    container.innerHTML = '';
    if(list.length===0){
      container.innerHTML = `<div class="card pad">No tasks match.</div>`;
      return;
    }
    const groupByDate = {};
    for(const t of list){ (groupByDate[t.due] ||= []).push(t); }
    for(const d of Object.keys(groupByDate).sort()){
      const group = groupByDate[d];
      const header = new Date(d+'T00:00').toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'});
      const block = document.createElement('div');
      block.className='card pad';
      block.innerHTML = `<div class="row spaced"><h4 style="margin:0">${header}</h4><span class="badge">${group.length}</span></div>` +
        group.map(renderTaskItem).join('');
      container.appendChild(block);
    }
    container.querySelectorAll('.task input[type="checkbox"]').forEach(cb=>{
      const id = cb.closest('.task').dataset.id;
      cb.addEventListener('change', ()=>toggleComplete(id, cb.checked));
    });
    container.querySelectorAll('[data-act="edit"]').forEach(btn=>{
      const id = btn.closest('.task').dataset.id;
      btn.addEventListener('click', ()=>editTaskDialog(state.tasks.find(t=>t.id===id)));
    });
    container.querySelectorAll('[data-act="del"]').forEach(btn=>{
      const id = btn.closest('.task').dataset.id;
      btn.addEventListener('click', ()=>{
        if(confirm('Delete this task?')){
          state.tasks = state.tasks.filter(t=>t.id!==id);
          recomputeScores(); saveState();
        }
      });
    });
  }

  function renderStats(){
    // Top KPIs
    $('#kpiTotal').textContent = state.counters.totalCompleted;
    $('#kpiScore').textContent = state.scores.total;
    $('#liveScore').textContent = state.scores.total;

    // Score tiles
    const sGrid = $('#scoreGrid');
    sGrid.innerHTML = '';
    for(const c of CATS){
      const tile = document.createElement('div');
      tile.className='tile';
      tile.style.boxShadow='inset 0 0 0 2px '+CAT_COLORS[c];
      tile.innerHTML = `
        <div class="row spaced">
          <div class="row" style="gap:8px">
            <span class="badge cat-badge cat-${c}">${c}</span>
          </div>
          <span class="prio">
            ${prioDot('Low')} ${state.weights.Low}
            ${prioDot('Medium')} ${state.weights.Medium}
            ${prioDot('High')} ${state.weights.High}
          </span>
        </div>
        <div class="big">${state.scores.byCategory[c]||0}</div>
        <small>Score</small>
      `;
      sGrid.appendChild(tile);
    }

    // Completed counters table-like
    const table = document.createElement('div');
    table.className='grid';
    table.style.gap='8px';
    const head = document.createElement('div');
    head.className='row spaced';
    head.innerHTML = `<span class="badge">Category</span><span class="badge">Low</span><span class="badge">Medium</span><span class="badge">High</span>`;
    table.appendChild(head);

    for(const c of CATS){
      const row = document.createElement('div');
      row.className='row spaced';
      const b = state.counters.byCategoryPriority[c];
      row.innerHTML = `
        ${catBadge(c)}
        <div class="prio"><span class="dot low"></span> ${b.Low}</div>
        <div class="prio"><span class="dot med"></span> ${b.Medium}</div>
        <div class="prio"><span class="dot high"></span> ${b.High}</div>
      `;
      table.appendChild(row);
    }
    const wrap = $('#counterTable');
    wrap.innerHTML = '';
    wrap.appendChild(table);
  }

  function refreshAll(){
    renderTodayList($('#todayFilters .chip.active')?.dataset.cat || 'all');
    renderTaskList();
    renderCalendar();
    renderStats();
  }

  /** ---------- Edit Dialog (inline minimal) ---------- **/
  function editTaskDialog(task){
    const title = prompt('Edit title:', task.title);
    if(title===null) return;
    const notes = prompt('Edit notes:', task.notes||'');
    const due = prompt('Edit due date (YYYY-MM-DD):', task.due);
    const priority = prompt('Priority (Low|Medium|High):', task.priority);
    const category = prompt('Category ('+CATS.join('|')+'):', task.category);
    if(!title.trim()) return alert('Title required.');
    if(!CATS.includes(category)) return alert('Invalid category.');
    if(!['Low','Medium','High'].includes(priority)) return alert('Invalid priority.');
    if(!/^\d{4}-\d{2}-\d{2}$/.test(due)) return alert('Invalid date format.');
    task.title = title.trim();
    task.notes = notes.trim();
    task.due = due;
    task.priority = priority;
    task.category = category;
    recomputeScores();
    saveState();
  }

  /** ---------- Import / Export / Clear ---------- **/
  $('#btnExport').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `taskforge-backup-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  let pendingImport = null;
  $('#importFile').addEventListener('change', (e)=>{
    pendingImport = e.target.files?.[0] || null;
  });
  $('#btnImport').addEventListener('click', async ()=>{
    if(!pendingImport) return alert('Select a JSON file first.');
    try{
      const text = await pendingImport.text();
      const data = JSON.parse(text);
      // Basic validation
      if(!data || !Array.isArray(data.tasks)) throw new Error('Invalid backup file.');
      // Replace
      state = data;
      // Ensure structure
      state = loadState()||state; // triggers guards
      recomputeScores();
      saveState();
      pendingImport = null;
      $('#importFile').value = '';
      alert('Import complete.');
    }catch(err){
      console.error(err); alert('Import failed: '+err.message);
    }
  });

  $('#btnClearAll').addEventListener('click', ()=>{
    if(confirm('This will wipe all tasks and stats. Proceed?')){
      state = freshState(); saveState();
    }
  });

  /** ---------- Init Calendar ---------- **/
  renderCalHeader();
  renderCalendar();

  /** ---------- Initial Render ---------- **/
  recomputeScores();
  saveState(); // also renders

  /** ---------- PWA: Manifest + Service Worker (single-file) ---------- **/
  (function bootstrapPWA(){
    // Minimal SVG icon
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#6dd3fb"/><stop offset="1" stop-color="#7df8c3"/></linearGradient></defs><rect width="512" height="512" rx="96" fill="#0b0f14"/><circle cx="256" cy="256" r="160" fill="url(#g)"/><text x="256" y="292" text-anchor="middle" font-family="Arial" font-size="180" font-weight="900" fill="#0b0f14">★</text></svg>`;
    const iconBlob = new Blob([svg], {type:'image/svg+xml'});
    const iconURL = URL.createObjectURL(iconBlob);
    const manifest = {
      name:"TaskForge",
      short_name:"TaskForge",
      start_url:"./",
      display:"standalone",
      background_color:"#0b0f14",
      theme_color:"#0b0f14",
      icons:[
        {"src":iconURL,"type":"image/svg+xml","sizes":"512x512","purpose":"any"}
      ]
    };
    const manBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const manURL = URL.createObjectURL(manBlob);
    const link = document.createElement('link'); link.rel='manifest'; link.href=manURL; document.head.appendChild(link);

    // Service Worker (cache-first)
    const swCode = `
      const CACHE = 'taskforge-cache-v1';
      self.addEventListener('install', e=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
        self.skipWaiting();
      });
      self.addEventListener('activate', e=>{
        e.waitUntil(self.clients.claim());
      });
      self.addEventListener('fetch', e=>{
        const req = e.request;
        // Only handle GET
        if(req.method !== 'GET') return;
        e.respondWith(
          caches.match(req).then(cached => {
            if(cached) return cached;
            return fetch(req).then(res=>{
              // clone & store dynamically
              const copy = res.clone();
              caches.open(CACHE).then(c=>c.put(req, copy)).catch(()=>{});
              return res;
            }).catch(()=> caches.match('./'));
          })
        );
      });
    `;
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    const swURL = URL.createObjectURL(swBlob);
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register(swURL).catch(console.warn);
    }

    // A2HS helper
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt = e; $('#btnInstall').disabled=false;
    });
    $('#btnInstall').addEventListener('click', async ()=>{
      if(!deferredPrompt){ alert('Install prompt not available—use your browser\'s “Add to Home Screen”.'); return; }
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    });
  })();

})();
</script>
</body>
</html>
